(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var Grid=require("./grid.js"),Data={arrayBufferToGeoJSON:function(e){for(var r={type:"FeatureCollection",features:[],_cache:{}},t=new Uint32Array(e),a=0;a<t.length;a++){var o=t[a],n=1048575&o,i=o>>>24,u=this.cellIdToCoordinates(n),l={type:"Feature",id:a,geometry:{type:"Polygon",coordinates:[u]},properties:{cellId:n,value:i}};r.features.push(l),r._cache[n]=l}return r},arrayBufferToGrid:function(e,r,t){for(var a=r[1],o=r[0],n=new Uint8ClampedArray(a*o*4),i=new Uint32Array(e),u=[],l=0;l<i.length;l++){var d=i[l],s=1048575&d,y=s<<2,f=d>>>24,c=d3.rgb(t(f)),p=255;n[y+0]=c.r,n[y+1]=c.g,n[y+2]=c.b,n[y+3]=p,u[s]=f}return new Grid(n,r,u)},uInt8ArrayToGeoJSON:function(e){for(var r={type:"FeatureCollection",features:[]},t=0;t<e.length;t+=4){var a=t/4+1,o=e[t],n=e[t+1],i=e[t+2],u=e[t+3];if(0!==o||0!==n||0!==i||0!==u){var l=this.cellIdToCoordinates(a),d={type:"Feature",id:t,geometry:{type:"Polygon",coordinates:[l]},properties:{rgba:[o,n,i,u]}};r.features.push(d)}}return r}};module.exports=Data;

},{"./grid.js":2}],2:[function(require,module,exports){
var Grid=function(s,t,i){this.data=s,this.rows=t[1],this.cols=t[0],this.rawData=i,this.cellCache=[],this.getCell=function(s){return this.rawData?this.rawData[s]:void 0},this.cellIdToLonLat=function(s){var t=s-1,i=-180+t%this.cols/this.cols*this.rows,o=90-~~(t/this.cols)*(180/this.rows);return[i,o]},this.coordinatesToCellId=function(s){var t=s[0],i=s[1],o=~~(this.rows-(i+90)/180*this.rows),h=~~((t+180)/360*this.cols),r=o*this.cols+h+1;return r},this.cellIdToCoordinates=function(s){if(this.cellCache[s])return this.cellCache[s];rows=this.rows,cols=this.cols;var t=360/cols,i=180/rows,o=this.cellIdToLonLat(s),h=[o,[o[0]+t,o[1]],[o[0]+t,o[1]-i],[o[0],o[1]-i],o];return this.cellCache[s]=h,h}};module.exports=Grid;

},{}],3:[function(require,module,exports){
var HUD=function(t){var e=t.options.hud||{},o=t.container.append("canvas").style("position","absolute").style("top","0px").style("left","0px").style("z-index","2"),i=o.node().getContext("2d");this.context=i,this.path=d3.geo.path().projection(t.projection).context(this.context),this.resize=function(t,e){o.attr("width",t),o.attr("height",e)},this.update=function(o,a,n){var r=d3.format(" >+7.3f"),l=e.fontSize||30,s=e.verticalOffset||10,d=e.fontColor||"white",c=e.fontFace||"monospace",h=l+"px "+c,p=l+s,f=i.createLinearGradient(0,0,0,p),y=t.width,g=t.height;f.addColorStop(0,"rgba(0,0,0,0.0)"),f.addColorStop(1,"rgba(0,0,0,1.0)"),i.clearRect(0,0,y,g),i.save(),i.translate(0,g-p),i.fillStyle=f,i.fillRect(0,0,y,p);var v=["cell:",o,"(",r(a[0]),"°,",r(a[1]),"°)"].join("");void 0!==n&&(v+=" value: "+d3.format(".4e")(n)),i.font=h,i.fillStyle=d,i.fillText(v,0,p-s),i.restore();var x={type:"Feature",geometry:{type:"Polygon",coordinates:[t.getGrid().cellIdToCoordinates(o)]}};i.beginPath(),i.strokeStyle="white",i.lineWidth=2,this.path(x),i.stroke()}};module.exports=HUD;

},{}],4:[function(require,module,exports){
var Grid=require("./grid.js"),HUD=require("./hud.js"),Layer=require("./layer.js"),Legend=require("./legend.js"),DataImport=require("./data-import.js");try{new Uint8ClampedArray}catch(e){window.Uint8ClampedArray=Uint8Array}var defaultColorScale=d3.scale.quantize().domain([0,255]).range(["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"]),GridMap=function(t,o){var e=this;this.rotateLatitude=0,this.rotateLongitude=0,this.container=d3.select(t);var i=d3.geo.graticule()(),r=this.container.node().getBoundingClientRect();this.width=0|r.width,this.height=0|r.height,this.layers=[],this.options=o||{},this.seaColor=this.options.seaColor||"rgba(21,98,180,.8)",this.graticuleColor=this.options.graticuleColor||"rgba(255,255,255,.3)",e.area=1;var n=d3.geo.transform({point:function(t,o,i){i>=e.area&&this.stream.point(t,o)}});this.dispatch=d3.geo.GridMap.dispatch,this.projection=this.options.projection||d3.geo.aitoff(),this.projection.translate([this.width/2,this.height/2]).clipExtent([[0,0],[e.width,e.height]]).precision(.1),this.canvas=this.container.append("canvas").style("position","absolute").style("top","0px").style("left","0px"),this.context=this.canvas.node().getContext("2d");var a=new HUD(this);this.colorScale=this.options.colorScale||defaultColorScale,this.options.zoomLevels||(this.options.zoomLevels=[1,2,4,8]),this.options.legend&&(this.options.context=a.context,this.options.colorScale=this.colorScale,this.legend=new Legend(this.options),this.legend.draw()),this.simplifyingPath=d3.geo.path().projection({stream:function(t){return n.stream(e.projection.stream(t))}}).context(this.context),this.path=d3.geo.path().projection(this.projection).context(this.context),this.init=function(){this.initEvents(),this.resize()},this.getGrid=function(){for(var t=0;t<this.layers.length;t++)if(this.layers[t].grid)return this.layers[t].grid},this.onMouseMove=function(){if(e.options.onCellHover||e.options.hud){var t=e.projection.invert(d3.mouse(this));if(t){var o=null,i=null,r=e.getGrid();r&&t[0]&&t[1]&&t[0]>-180&&t[0]<180&&t[1]>-90&&t[1]<90&&(o=r.coordinatesToCellId(t),i=r.getCell(o),i&&e.options.onCellHover&&e.options.onCellHover(i,o));var n=i/255;a&&o&&a.update(o,t,n),e.legend&&(e.legend.draw(),e.legend.highlight(n))}}},this.initEvents=function(){var t=150,o=d3.behavior.drag().on("dragstart",function(){}).on("drag",function(){e.rotateLongitude+=100*d3.event.dx/t,e.rotateLatitude-=100*d3.event.dy/t,e.projection.rotate([e.rotateLongitude,e.rotateLatitude]),e.drawAnimation()}).on("dragend",function(){e.draw()});if(!e.options.disableMouseZoom){var i=d3.behavior.zoom().on("zoomstart",function(){}).on("zoomend",function(){e.draw()}).on("zoom",function(o){t=d3.event.scale,e.area=2e4/t/t,e.projection.scale(t),e.drawAnimation()}).scale(t).scaleExtent([0,4e3]);this.container.call(i)}this.container.call(o),this.container.on("mousemove",e.onMouseMove),d3.select(window).on("resize",d3.geo.GridMap.dispatch.resize),d3.geo.GridMap.dispatch.on("resize."+e.container.attr("id"),function(){e.resize()})},this.drawWorld=function(){this.context.clearRect(0,0,this.width,this.height),this.context.beginPath(),this.path({type:"Sphere"}),this.context.fillStyle=this.seaColor,this.context.fill()},this.drawGeoJSONLayer=function(t){e.context.beginPath(),t.simplified?e.simplifyingPath(t.json):e.path(t.json),e.context.strokeStyle=t.options.strokeColor,e.context.lineWidth=.5,e.context.stroke(),e.context.fillStyle=t.options.fillColor,e.context.fill()},this.drawGrid=function(t){for(var o=this.context.getImageData(0,0,this.width,this.height),i=o.data,r=0;r<this.height;r++)for(var n=0;n<this.width;n++){var a=this.projection.invert([n,r]);if(a){var s=a[0],d=a[1];if(180>=s&&s>=-180&&90>=d&&d>=-90){var h=4*(n+this.width*r),c=~~(~~((90-d)/180*t.rows)*t.cols+(180+s)/360*t.cols+1);0!==t.data[4*c+3]&&(i[h]=t.data[4*c],i[h+1]=t.data[4*c+1],i[h+2]=t.data[4*c+2],i[h+3]=t.data[4*c+3])}}}e.context.putImageData(o,0,0)},this.drawGraticule=function(){this.context.beginPath(),this.path(i),this.context.closePath(),this.context.lineWidth=1,this.context.strokeStyle=this.graticuleColor,this.context.stroke()},this.drawLayers=function(t){for(var o=0;o<e.layers.length;o++){var i=e.layers[o],r=!t||i.options.renderOnAnimate;r&&(i.grid?e.drawGrid(i.grid):i.json&&("Topology"===i.json.type?e.drawTopoJSONLayer(i):e.drawGeoJSONLayer(i)))}},this._draw=function(){e.dispatch.drawStart(),e.drawWorld(),e.drawLayers(),e.drawGraticule(),e.dispatch.drawEnd()},this.drawAnimation=function(){var t=!0;e.drawWorld(),e.drawLayers(t),e.drawGraticule()};var s=function(t,o){var e=-1;return function(){e>-1&&window.clearTimeout(e),e=window.setTimeout(t,o)}};e.draw=s(e._draw,500),this._resize=function(){console.log("resizing ",e);var t=e.container.node().getBoundingClientRect();e.width=0|t.width,e.height=0|t.height,e.canvas.attr("width",e.width),e.canvas.attr("height",e.height),a&&a.resize(e.width,e.height),e.projection.translate([e.width/2,e.height/2]).clipExtent([[0,0],[e.width,e.height]]),e.draw()},this.resize=s(e._resize,200),this.panToCentroid=function(t){var o=d3.geo.centroid(t),e=this.projection.rotate();e[0]=-o[0],this.projection.rotate(e)},this.addLayer=function(t,o){var i=new Layer(o);if(t.constructor===ArrayBuffer){var r=DataImport.arrayBufferToGrid(t,o.gridSize,e.colorScale);i.grid=r}else if(t.constructor===Uint8Array||t.constructor===Uint8ClampedArray){var r=new Grid(t,o.gridSize);i.grid=r}else{if("Topology"===t.type){var n=o&&o.topojsonObject||t.objects[Object.keys(t.objects)[0]];t=topojson.feature(topojson.presimplify(t),n),i.simplified=!0}i.json=t}return e.layers.push(i),e.layers.sort(function(t,o){return t.options.zIndex-o.options.zIndex}),e.draw(),i},this.removeLayer=function(t){if("number"==typeof t)e.layers.splice(t,1);else for(var o=0;o<e.layers.length;o++)e.layers[o]===t&&e.layers.splice(o,1)},this.zoomTo=function(t){e.area=2e4/t/t,e.projection.scale(t),e.draw()},this.zoomIn=function(){e.options.zoomLevels.sort(function(t,o){return t-o});for(var t=e.projection.scale(),o=0;o<e.options.zoomLevels.length;o++)if(150*e.options.zoomLevels[o]>t)return void e.zoomTo(150*e.options.zoomLevels[o])},this.zoomOut=function(){e.options.zoomLevels.sort(function(t,o){return t-o});for(var t=e.projection.scale(),o=e.options.zoomLevels.length-1;o>=0;o--)if(150*e.options.zoomLevels[o]<t)return void e.zoomTo(150*e.options.zoomLevels[o])},this.init()};window.d3.geo.GridMap=GridMap,window.d3.geo.GridMap.dispatch=d3.geo.GridMap.dispatch||d3.dispatch("drawStart","drawEnd","resize");
},{"./data-import.js":1,"./grid.js":2,"./hud.js":3,"./layer.js":5,"./legend.js":6}],5:[function(require,module,exports){
var Layer=function(o){this.options=o||{},this.options.strokeColor=this.options.strokeColor||"rgba(100,100,100,.8)",this.options.fillColor=this.options.fillColor||"rgba(237,178,48,1)",void 0===this.options.zIndex&&(this.options.zIndex=1),this.options.hasOwnProperty("renderOnAnimate")||(this.options.renderOnAnimate=!0)};module.exports=Layer;

},{}],6:[function(require,module,exports){
var Legend=function(e){var t=e.context,l=e.width||150,r=e.height||30,a=e.cornerOffset||{x:5,y:20},n=e.margin||5;this.complementaryColor=function(e){function t(e){return(e+127)%255}var l=d3.rgb(t(e.r),t(e.g),t(e.b));return l},this.xy=function(){return{x:t.canvas.clientWidth-l-a.x,y:t.canvas.clientHeight-r-a.y}},this.draw=function(a){var i=this.xy(),o=[{x:0,label:"0.0"},{x:51,label:"0.2"},{x:102,label:"0.4"},{x:153,label:"0.6"},{x:204,label:"0.8"},{x:255,label:"1.0"}],c=(l-2*n)/o.length;t.save(),t.translate(i.x,i.y),t.clearRect(0,0,l,r),t.fillStyle="rgba(0,0,0,.5)",t.fillRect(0,0,l,r);var h="8px Helvetica";t.font=h;for(var s=0;s<o.length;s++){var x=o[s],f=d3.rgb(e.colorScale(x.x));t.fillStyle=f,t.fillRect(s*c+n,n,c,r-2*n),t.fillStyle=this.complementaryColor(f),t.fillText(x.label,(s+.5)*c,r/2+2)}t.restore()},this.highlight=function(a){t.save();var i=this.xy();t.translate(i.x+n,i.y+n);var o=d3.rgb(e.colorScale(255*a));t.strokeStyle=this.complementaryColor(o);var c=(l-2*n)*a;t.lineWidth=2,t.beginPath(),t.moveTo(c,0),t.lineTo(c,r-2*n),t.stroke(),t.restore()}};module.exports=Legend;

},{}]},{},[4]);
